# 开放性问题
## 故障排查思路
### 发生故障时
- 首先分析故障等级和影响范围，第一时间汇报直属领导；
- 然后针对程序本身，业务逻辑，中间件，操作系统，网络等方面进行故障分析、修改和恢复；

#### 程序
- 查看服务进程是否存在，如果发现程序已经挂掉，比如已经 OOM 了，马上把程序拉起来，保证业务可用是第一要素；
- 但是必须在启动时加上 OOM 自动 Dump 的虚拟机参数，便于我们用可视化工具进行分析，当然也可以手动执行 jmap 命令进行 Dump；
- 如果是程序 CPU 占用过高，可以使用 top 命令定位到 CPU 过高的进程，进一步用 top -Hp 定位到具体线程，然后用 jstack 命令导出进程快照，最后根据线程十六进制 pid 进行查找和定位有问题的代码；

#### 中间件
- 排查依赖的中间件是否正常；
- MySQL 连接数耗尽，默认是 151，可以提高最大连接数，同时排查代码中是否有忘记关闭连接的情况，否则连接数最终还是会被耗尽，Redis 同样有这个问题；
- MySQL 死锁，SHOW ENGINE INNODB STATUS 查看死锁日志进行分析；
- MySQL 慢查询日志，一定要开始慢查询日志，将执行缓慢的 SQL 语句保存下来，用 Explain 命令进行分析优化；

#### 操作系统 & 网络
- 磁盘是否被占满，df -H 命令，进一步用 du -h 找到最大的目录，例：低版本 zookeeper 频繁写入时会有大量日志，如不清理会占满磁盘，高版本会自动清理；
- 网络不通，traceroute 查看路由跟踪信息，tcpdump 抓包，例：snmp 采集时只有发出去的包，没有接受包的包，关闭防火墙或者放开对应的端口；

#### 业务逻辑 Arthas
- Arthas 阿里开源的 Jaca 在线诊断工具；
- 通过 watch 命令可以对方法执行参数进行观测，得到参数后可以在开发环境 debug 调试，修改业务逻辑；
- 基于修改后的 class 文件，使用 redefine 命令进行重新进行类加载，达到代码热更新的目的；

### 故障前
- 做好程序以及中间件监控和告警，有问题能够快速通知相关人员；
- 高可用部署，比如注册中心集群、MySQL 集群、Redis 集群、Kafka 集群等等；
- 做好备份，比如每天凌晨执行 mysqldump 命令对数据进行全量备份，还有原始数据保存在 HDFS 中；
- 程序日志要规范，主要流程的日志要详细记录，至少保存 15 天的日志，或者将日志保存到 ES 中，进一步提高日志排查的效率；

### 故障后
- 对问题进行回顾和总结，可以在例会上进行分享；
- 将问题以及解决方式详细记录在公司 Wiki 上，有利于后续的维护；

## 超时未支付订单自动取消
### 定时任务
- 使用 xxl-job 定时扫描数据库，